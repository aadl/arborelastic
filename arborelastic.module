<?php

use Elasticsearch\ClientBuilder;

/**
 * Display help and module information
 * @return help text for section
 */
function arborelastic_help($path, $arg) {
  $output = '';

  switch ($path) {
    case "admin/help#arborelastic":
      $output = '<p>' .  t("Custom search with Elasticsearch") . '</p>';
      break;
  }

  return $output;
}

function arborelastic_search($path_id, $query, $args = []) {
  $search_fields = [
    'author',
    'bib_created',
    'callnum',
    'pub_year',
    'publisher',
    'subjects',
    'title'
  ];

  // ignore colons unless part of a field query
  $is_search_field = array_filter($search_fields, function($k) use($query) {
    if (strpos($query, $k . ':') !== false) return true;
  });
  if (!count($is_search_field)) $query = str_replace(':', '', $query);

  if (strpos($query, '"') === false) {
    // escape these characters unless phrase search
    $search_escapes = [',', '-'];
    $search_replace = ['', ' '];
    $query = str_replace($search_escapes, $search_replace, $query);
    $fuzzy = explode(' ', $query);
    $query = [];
    foreach($fuzzy as $fuz) {
      $query[] = (strlen($fuz) > 3 ? $fuz . '~1' : $fuz);
    }
    $query = implode(' ', $query);
  }
  $indexes = \Drupal::config('arborelastic.settings')->get('arborelastic_indexes');
  $indexes = explode("\n", $indexes);
  foreach ($indexes as $i => $index) {
    $parts = explode(':', $index);
    $indexes[$parts[0]] = array('index' => $parts[1], 'type' => $parts[2]);
    unset($indexes[$i]);
  }
  $index = $indexes[$path_id]['index'];

  $hosts = [
    [
      'host' => \Drupal::config('arborelastic.settings')->get('arborelastic_host'),
      'port' => \Drupal::config('arborelastic.settings')->get('arborelastic_port'),
      'user' => \Drupal::config('arborelastic.settings')->get('arborelastic_user'),
      'pass' => \Drupal::config('arborelastic.settings')->get('arborelastic_pass'),
    ]
  ];

  $es_client = ClientBuilder::create()->setHosts($hosts)->build();

  $size = 25; // default number of results to return
  $from = 0;

  // Limit search results to active
  if ($index == 'bibs') {
    $args['active'] = 1;
  }

  // Parse Args and add to query string
  foreach ($args as $field => $value) {
    if ($field == 'size') {
      $size = $value;
    }
    elseif ($field == 'page') {
      $from = $value;
    }
    elseif ($field == 'sort') {
      $sort_parts = explode('~', $value);
      $sort_field = $sort_parts[0];

      // Check if keyword mapping exists for field
      $mapping = $es_client->indices()->getFieldMapping(['index' => $index, 'field' => $sort_field]);
      $type_mapping = array_shift($mapping[$index]['mappings']);
      $field_mapping = $type_mapping[$sort_field]['mapping'][$sort_field];
      if (isset($field_mapping['fields']['keyword'])) {
        $sort_field .= '.keyword';
      }

      $sort = [
        $sort_field => [
          'order' => (isset($sort_parts[1]) ? $sort_parts[1] : 'desc') // Default sort decending
        ]
      ];
    }
    else {
      if ($field == 'author') {
        $query .= ' AND ' . $field . ':(' . $value . ')';
      } 
      elseif ($field != 'gridview') {
        $query .= ' AND ' . $field . ':(' . str_replace(',', ' OR ', $value) . ')';
      }
    }
  }

  if ($path_id == 'community') {
    $es_query = [
      'bool' => [
        'must' => [
          [
            'query_string' => [
              'query' => $query,
              'fields' => ['_all'],
              'default_operator' => 'and'
            ]
          ]
        ],
        'filter' => [
          [
            'terms' => [
              'mat_code' => ['photo', 'issue', 'doc', 'article']
            ]
          ]
        ]
      ]
    ];
  } elseif ($path_id == 'website') {
    $es_query = [
      'bool' => [
        'must' => [
          [
            'query_string' => [
              'query' => $query,
              'fields' => ['_all'],
              'default_operator' => 'and'
            ]
          ]
        ],
        // 'should' => [
          
        // ]
      ]
    ];
    $es_query['bool']['must'][] = [
      'range' => [
        'field_event_start' => [
          'gte' => 'now',
          'format' => "yyyy-MM-dd'T'HH:mm:ss"
        ]
      ]
    ];
  } else {
    $es_query = [
      'function_score' => [
        'query' => [
          'bool' => [
            // the extra layer of array brackets is so we can add more to the must/should conditions
            'must' => [
              [
                'query_string' => [
                  'query' => $query,
                  'fields' => ['title^10', 'author^10', '_all'],
                  'default_operator' => 'and'
                ]
              ]
            ],
            'should' => [
              [
                'match' => [
                  'lang' => [
                    'query' => 'eng',
                    'boost' => 300
                  ]
                ]
              ]
            ]
          ]
        ],
        'field_value_factor' => [
          'field' => 'popular_alltime',
          'modifier' => 'log1p',
          'missing' => 0
        ]
      ]
    ];
  }

  $params = [
    'index' => $index,
    'from' => $from * $size,
    'body' => [
      'size' => $size,
      'query' => $es_query,
      'aggs' => [
        'mat_code' => [
          'terms' => [
            'field' => 'mat_code.keyword'
          ]
        ],
        'lang' => [
          'terms' => [
            'field' => 'lang.keyword'
          ]
        ]
      ]
    ]
  ];

  if (isset($sort)) {
    $params['body']['sort'] = $sort;
  }

  try {
    $result = $es_client->search($params);
  }
  catch (\Exception $e) {
    $result = [
      'error' => 'Elasticsearch Query Failed',
      'message' => $e->getMessage(),
    ];
  }

  $result['cur_page'] = $from;
  $result['size'] = $size;

  return $result;
}

function arborelastic_theme($existing, $type, $theme, $path) {
  return [
    'search_results' => [
      'variables' => [
        'path_id' => NULL,
        'api_key' => NULL,
        'lists' => NULL,
        'results' => NULL,
        'facets' => NULL,
        'gridview' => NULL,
        'pager' => NULL
      ]
    ]
  ];
}
