<?php

use Elasticsearch\ClientBuilder;

/**
 * Display help and module information
 * @return help text for section
 */
function arborelastic_help($path, $arg) {
  $output = '';

  switch ($path) {
    case "admin/help#arborelastic":
      $output = '<p>' .  t("Custom search with Elasticsearch") . '</p>';
      break;
  }

  return $output;
}

function arborelastic_search($path_id, $query, $args = []) {
  $indexes = \Drupal::config('arborelastic.settings')->get('arborelastic_indexes');
  $indexes = json_decode($indexes, TRUE);

  $hosts = [
    [
      'host' => \Drupal::config('arborelastic.settings')->get('arborelastic_host'),
      'port' => \Drupal::config('arborelastic.settings')->get('arborelastic_port'),
      'user' => \Drupal::config('arborelastic.settings')->get('arborelastic_user'),
      'pass' => \Drupal::config('arborelastic.settings')->get('arborelastic_pass'),
    ]
  ];

  $es_client = ClientBuilder::create()->setHosts($hosts)->build();

  $es_query = [
    'bool' => [
      'must' => [
        ['match' => ['_all' => $query] ],
      ],
    ]
  ];

  // Process arguments
  $size = 10;
  foreach ($args as $field => $value) {
    if ($field == 'size') {
      $size = $value;
    } else {
      $values = explode(',', $value);
      $es_query['bool']['must'][] = ['terms' => [$field => $values]];
    }
  }

  // Set up facets as aggregates
  $aggs = [];
  foreach ($indexes[$path_id]['facets'] as $facet) {
    $aggs[$facet] = ['terms' => ['field' => $facet . '.keyword']];
  }

  $params = [
      'index' => $indexes[$path_id]['es_index'],
      'type' => $indexes[$path_id]['type'],
      'from' => $_GET['page'] * $size,
      'body' => [
        'size' => $size,
        'query' => $es_query,
        'aggs' => $aggs,
      ]
  ];

  return $es_client->search($params);
}

function arborelastic_theme($existing, $type, $theme, $path) {
  return [
    'catalog_results' => [
      'variables' => [
        'results' => NULL
      ]
    ]
  ];
}
